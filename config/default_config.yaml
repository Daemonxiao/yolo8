# 实时视频检测系统配置文件

# 模型配置
model:
  # 默认模型（用于兼容旧代码）
  path: "pt_dir/constuction_waste/constuction_waste/best.pt"
  
  # 算法模型映射（算法名称 -> 模型路径）
  # 场景下发时根据 algorithm 字段自动选择模型
  algorithm_models:
    "火焰检测": "pt_dir/fire_smoke/best.pt"
    "人员检测": "pt_dir/person/best.pt"
    "安全帽检测": "pt_dir/helmet/best.pt"
    "垃圾分类": "pt_dir/constuction_waste/constuction_waste/best.pt"
    "裸土检测": "pt_dir/luotu/best.pt"
  
  # 算法目标类别映射（可选，用于类别过滤）
  # 空列表 [] 表示检测所有类别
  algorithm_classes:
    "火焰检测": [ "fire", "smoke" ]
    "人员检测": [ "person" ]
    "垃圾分类": [ "" ]  # 检测所有垃圾类别
    "裸土检测": [ "noncovered" ]
    "安全帽检测": [ "head" ]  # 需要同时检测头部和安全帽
  
  # 算法自定义处理类型映射（可选）
  # 每个算法可以指定自己的 custom_type
  algorithm_custom_types:
    "高温预警": "high_temperature_alert"
    "晨会预警": "morning_meeting_alert"
    "天气预警": "weather_safety_alert"
  
  # 是否在启动时预加载所有模型
  preload_all: true

# 检测参数配置
detection:
  # 置信度阈值（0.0-1.0）
  confidence_threshold: 0.5
  # IoU阈值（用于非极大值抑制）
  iou_threshold: 0.45
  # 检测图像尺寸
  image_size: 640
  # 处理频率（每秒处理多少帧，0表示处理所有帧）
  # 注意：这里是帧率（FPS），不是间隔时间
  # 每5秒1帧 = 1÷5 = 0.2 FPS
  fps_limit: 1
  # 最大同时处理的视频流数量
  max_streams: 100
  # 自动缩放高分辨率图像以提高性能
  auto_resize: true
  # 自动缩放的最大分辨率（单边）
  max_resolution: 640
  # 自定义处理类型（可选）
  # 可选值: "", "high_temperature_alert", "morning_meeting_alert", "weather_safety_alert", "helmet_detection_alert"
  custom_type: ""
  
  # 自定义处理配置
  custom_type_config:
    # 高温预警配置（当custom_type为"high_temperature_alert"时使用）
    temperature_threshold: 35.0    # 高温阈值（摄氏度）
    temperature_source: "api"      # 温度来源: "api", "sensor", "fixed"
    enabled: true                  # 是否启用
    api_key: "463f3a37789523d2bbbe619be3d03981 "                    # 天气API密钥
    city: "310000"                   # 城市名称
    fixed_temperature: 25.0        # 固定温度值（当source为"fixed"时使用）
    
    # 安全晨会预警配置（当custom_type为"morning_meeting_alert"时使用）
    meeting_start_time: "08:00"    # 晨会开始时间
    meeting_end_time: "08:30"      # 晨会结束时间
    weekdays: [ 0, 1, 2, 3, 4 ]      # 工作日（0=周一, 6=周日）
    person_class_names: [ "person", "人", "人员" ]  # 人员类别名称
    
    # 防台防汛施工预警配置（当custom_type为"weather_safety_alert"时使用）
    wind_power_threshold: 6        # 风力阈值（级）
    weather_source: "api"          # 天气数据源: "api", "fixed"
    dangerous_weather_keywords: [ "特大暴雨", "大暴雨", "暴雨", "台风", "飓风", "强风" ]  # 危险天气关键词
    fixed_wind_power: 3            # 固定风力值（当source为"fixed"时使用）
    fixed_weather_type: "晴"       # 固定天气类型（当source为"fixed"时使用）

# 报警规则配置
alarm:
  # 触发报警的最小置信度
  min_confidence: 0.5
  # 连续检测到目标的帧数才触发报警
  consecutive_frames: 3
  # 报警冷却时间（秒）- 避免频繁报警
  cooldown_seconds: 30
  # 报警级别
  levels:
    low: 0.3
    medium: 0.5
    high: 0.7
  # 告警发送方式（可选值：http, kafka, both）
  # - http: 只通过HTTP回调发送到设备平台
  # - kafka: 只通过Kafka推送
  # - both: 同时使用HTTP和Kafka
  notification_method: "http"  # 默认同时使用两种方式

# 视频流配置
video_streams:
  # 缓冲区大小（帧数）
  buffer_size: 5
  # 连接超时时间（秒）
  connection_timeout: 10
  # 重连间隔（秒）
  reconnect_interval: 5
  # 最大重连次数
  max_reconnect_attempts: 3
  # 支持的视频格式
  supported_formats:
    - "rtsp"
    - "rtmp"
    - "http"
    - "file"
    - "camera"

# API服务配置
api:
  # 服务端口
  port: 8080
  # 服务主机
  host: "0.0.0.0"
  # API版本
  version: "v1"
  # 是否启用调试模式
  debug: false
  # 允许的跨域来源
  cors_origins:
    - "*"

# 服务器配置（重要！用于生成告警图片/录像URL）⭐
server:
  # 服务器公网地址或域名，用于生成可访问的URL
  # 外部平台将通过此URL访问告警图片和录像
  public_url: "http://localhost:8080"  # 修改为实际的公网地址，如 "http://ai.example.com"
  # 如果使用Nginx代理，配置Nginx监听的端口
  nginx_port: 80  # 或 443 (HTTPS)

# 设备平台配置（重要！必须配置）⭐
device_platform:
  # 设备管理平台地址
  base_url: "http://127.0.0.1:8081"  # 修改为实际的设备平台地址
  # 接口调用超时时间（秒）
  timeout: 10
  # 失败重试次数
  retry_times: 3
  # 是否启用（开发调试时可设为false）
  enabled: true

# Kafka配置（重要！必须配置）⭐
kafka:
  # 外部Kafka服务器地址（注意：这里应该是 Kafka 地址，不是 HTTP 地址）
  bootstrap_servers: "127.0.0.1:9092"  # 修改为实际的Kafka地址，格式：host:port
  # 告警推送Topic
  topic: "event-alarm"
  # 是否启用Kafka推送
  enabled: true

# 日志配置
logging:
  # 日志级别
  level: "INFO"
  # 日志文件路径
  file_path: "logs/detection.log"
  # 日志文件大小限制（MB）
  max_file_size: 100
  # 保留的日志文件数量
  backup_count: 5
  # 日志格式
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# 性能配置
performance:
  # 是否使用GPU
  use_gpu: false
  # GPU设备ID
  gpu_device: 0
  # 工作线程数
  worker_threads: 4
  # 内存使用限制（MB）
  memory_limit: 2048

# 存储配置
storage:
  # 是否保存检测结果信息文件
  save_results: true
  # 是否保存检测图像
  save_images: true
  # 结果保存路径
  results_path: "results/"
  # 图像保存路径
  images_path: "results/images/"
  # 数据保留天数
  retention_days: 30
  # 是否只保存有检测结果的帧
  save_only_detections: true
  # 最大保存文件数量（防止磁盘满）
  max_saved_files: 10000
  # 图像质量设置
  image_format: "png"  # 图像格式: "png"(无损) 或 "jpg"(有损)
  jpeg_quality: 100    # JPEG质量 (1-100，仅当format为jpg时有效)
  png_compression: 1   # PNG压缩级别 (0-9，0最快，9最小)
  # 视频捕获设置
  capture_width: 640   # 期望的捕获宽度 (降低以避免H264问题)
  capture_height: 480  # 期望的捕获高度
  capture_fps: 15      # 期望的捕获帧率 (降低以减少编码负担)
  # 优先编码格式 ("YUYV", "MJPEG", "AUTO")
  preferred_codec: "YUYV"
