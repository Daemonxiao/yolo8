# 检测结果本地保存功能

本文档介绍系统的检测结果本地保存功能，包括图像保存、信息记录和结果管理。

## 🎯 功能概述

系统会自动保存所有检测到目标的帧，为每个检测结果创建独立的文件夹，包含：
- **原始图片**: 未处理的原始帧
- **标注图片**: 带检测框和标签的图片
- **裁剪图片**: 每个检测目标的单独裁剪图
- **信息文件**: 详细的JSON格式检测信息

## 📁 目录结构

```
results/
├── 2024-01-15/                    # 按日期分组
│   ├── camera_001/                # 按流ID分组
│   │   ├── 14-30-25-123_frame_1001/    # 时间戳_帧号
│   │   │   ├── detection_info.json     # 检测信息文件
│   │   │   ├── original.jpg            # 原始图片
│   │   │   ├── annotated.jpg           # 带标注图片
│   │   │   └── crops/                  # 裁剪图片目录
│   │   │       ├── 1_person_0.85.jpg   # ID_类别_置信度
│   │   │       └── 2_car_0.72.jpg
│   │   └── 14-31-10-456_frame_1045/
│   └── camera_002/
└── 2024-01-16/
```

## 🎨 图片保存功能

### 1. 原始图片 (original.jpg)
- 保存未经处理的原始视频帧
- 用于后续分析或作为证据保存

### 2. 标注图片 (annotated.jpg)
- 在原图上绘制检测框和标签
- 不同置信度使用不同颜色：
  - 🟢 绿色: 高置信度 (≥0.7)
  - 🟡 黄色: 中等置信度 (0.5-0.7)
  - 🔴 红色: 低置信度 (<0.5)
- 显示目标类别、置信度和对象ID
- 添加时间戳、流信息和处理统计

### 3. 裁剪图片 (crops/)
- 为每个检测到的目标单独保存裁剪图
- 文件命名格式: `{ID}_{类别}_{置信度}.jpg`
- 便于目标识别和分类分析

## 📋 信息文件格式

每个检测结果都会生成一个 `detection_info.json` 文件：

```json
{
  "basic_info": {
    "timestamp": "2024-01-15T14:30:25.123000",
    "stream_id": "camera_001",
    "frame_id": 1001,
    "processing_time": 0.045,
    "video_source": "rtsp://192.168.1.100:554/live"
  },
  "stream_info": {
    "confidence_threshold": 0.25,
    "iou_threshold": 0.45,
    "fps_limit": 30,
    "total_frames_processed": 1001,
    "total_detections": 156
  },
  "detection_results": {
    "total_objects": 2,
    "objects": [
      {
        "id": 1,
        "class_name": "person",
        "class_id": 0,
        "confidence": 0.85,
        "bbox": {
          "x1": 100.5,
          "y1": 150.2,
          "x2": 200.8,
          "y2": 400.1,
          "width": 100.3,
          "height": 249.9
        },
        "center": {
          "x": 150.65,
          "y": 275.15
        },
        "area": 25048.7
      }
    ]
  },
  "alarm_info": {
    "has_alarm": true,
    "alarm_level": "high",
    "alarm_objects": [
      {
        "object_id": 1,
        "class_name": "person", 
        "confidence": 0.85,
        "alarm_level": "high"
      }
    ]
  }
}
```

## ⚙️ 配置选项

在 `config/default_config.yaml` 中配置保存行为：

```yaml
storage:
  # 是否保存检测结果信息文件
  save_results: true
  
  # 是否保存检测图像
  save_images: true
  
  # 结果保存路径
  results_path: "results/"
  
  # 图像保存路径
  images_path: "results/images/"
  
  # 数据保留天数
  retention_days: 30
  
  # 是否只保存有检测结果的帧
  save_only_detections: true
  
  # 最大保存文件数量（防止磁盘满）
  max_saved_files: 10000
```

## 🛠️ 结果查看工具

使用 `view_results.py` 脚本查看和管理保存的结果：

### 1. 查看总览
```bash
python scripts/view_results.py summary
```
输出示例：
```
📊 检测结果总览
==================================================
📅 2024-01-15: 45 个检测结果, 12 个报警
📅 2024-01-14: 32 个检测结果, 8 个报警
--------------------------------------------------
📈 总计: 77 个检测结果, 20 个报警
📁 涉及日期: 2 天
```

### 2. 查看某日详情
```bash
python scripts/view_results.py date 2024-01-15
```

### 3. 查看具体检测结果
```bash
python scripts/view_results.py detail 2024-01-15 camera_001 14-30-25-123_frame_1001
```

### 4. 按类别搜索
```bash
# 搜索所有人员检测
python scripts/view_results.py search person

# 搜索指定日期的车辆检测
python scripts/view_results.py search car --date 2024-01-15
```

### 5. 清理旧结果
```bash
# 清理30天前的结果
python scripts/view_results.py cleanup --days 30
```

## 📊 统计分析

### 按时间统计
- 每天的检测数量和报警数量
- 不同时间段的活动分布
- 检测趋势分析

### 按目标类别统计
- 各类目标的检测频率
- 置信度分布情况
- 报警触发率

### 按摄像头统计
- 各个摄像头的检测效果
- 性能对比分析
- 异常检测识别

## 🚨 报警信息记录

系统会自动记录报警相关信息：

### 报警级别判定
- **高级报警**: 置信度 ≥ 0.7
- **中级报警**: 置信度 0.5-0.7
- **低级报警**: 置信度 < 0.5

### 报警信息包含
- 触发报警的具体目标
- 报警时间和持续情况
- 置信度和位置信息
- 连续检测帧数统计

## 💾 存储管理

### 磁盘空间管理
- 自动创建目录结构
- 监控磁盘使用情况
- 达到限制时停止保存

### 数据保留策略
- 按配置的天数自动清理
- 优先删除旧的低置信度结果
- 保留重要的报警记录

### 性能优化
- 只保存有检测结果的帧
- 异步保存避免影响检测性能
- 压缩图片减少存储空间

## 🔧 维护建议

### 定期维护
1. **每周检查**: 查看磁盘使用情况
2. **每月清理**: 删除过期的检测结果
3. **定期备份**: 重要检测结果的备份

### 存储优化
1. **调整保存策略**: 根据需求调整置信度阈值
2. **图片压缩**: 降低图片质量减少存储空间
3. **选择性保存**: 只保存重要类别的检测结果

### 故障排除
1. **磁盘满**: 自动停止保存，清理旧文件
2. **权限问题**: 确保有写入权限
3. **文件损坏**: 检查JSON格式和图片完整性

通过这套完整的结果保存和管理系统，你可以：
- 🔍 追溯任何时间的检测结果
- 📊 分析检测效果和趋势
- 🚨 记录和回顾报警事件
- 📈 优化系统配置和性能
